<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sterling Catering - Room View</title>
    <style>
      :root {
        --brand-orange: #eb5638;
        --brand-orange-hover: #d94a2e;
        --brand-black: #2b2b2b;
        --brand-cream: #ebe5c0;
        --gray-50: #e6e0b8;
        --gray-200: #d4cea3;
        --gray-300: #b8b38f;
        --gray-400: #9a9578;
        --gray-500: #7a7660;
        --gray-600: #5a574a;
        --gray-700: #3d3b33;
        --success: #5a8a5a;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--brand-cream);
        color: var(--brand-black);
        height: 100vh;
        overflow: hidden;
      }

      .app-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* TOP BAR */
      .top-bar {
        background: var(--brand-black);
        padding: 1rem 1.5rem;
        border-bottom: 3px solid var(--brand-orange);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-center {
        text-align: center;
        flex: 1;
      }

      .header-center h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--brand-cream);
        margin-bottom: 0.125rem;
      }

      .header-center p {
        font-size: 0.75rem;
        color: var(--gray-400);
      }

      .top-right {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .badge {
        padding: 0.5rem 1rem;
        background: var(--gray-700);
        color: var(--brand-cream);
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .time-badge {
        background: var(--brand-orange);
        font-family: "Courier New", monospace;
      }

      .login-section {
        background: var(--gray-700);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .login-section input {
        padding: 0.5rem;
        border: none;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        width: 150px;
      }

      .login-section button {
        padding: 0.5rem 1rem;
        background: var(--brand-orange);
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        font-weight: 600;
      }

      .login-section button:hover {
        background: var(--brand-orange-hover);
      }

      /* MAIN LAYOUT */
      .main-layout {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 400px;
        overflow: hidden;
      }

      /* LEFT: TABLES GRID */
      .tables-grid-container {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .room-header {
        padding: 2rem 2rem 1rem 2rem;
        background: var(--brand-cream);
      }

      .room-header h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .room-header p {
        color: var(--gray-500);
        font-size: 0.875rem;
      }

      .tables-grid {
        flex: 1;
        overflow-y: auto;
        padding: 1rem 2rem 2rem 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 3rem;
        align-content: start;
      }

      .table-view {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
      }

      .table-container {
        position: relative;
        width: 280px;
        height: 280px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .table-center {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background: var(--brand-black);
        border: 4px solid var(--brand-orange);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--brand-cream);
        cursor: pointer;
        transition: all 150ms;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        position: relative;
        z-index: 1;
      }

      .table-center:hover {
        transform: scale(1.05);
      }

      .table-center strong {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .table-center span {
        font-size: 0.875rem;
        opacity: 0.9;
      }

      .res-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--brand-orange);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.6875rem;
        font-weight: 700;
      }

      .seat {
        position: absolute;
        width: 75px;
        height: 75px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 200ms cubic-bezier(0.34, 1.56, 0.64, 1);
        font-size: 0.75rem;
        font-weight: 600;
        border: 3px solid var(--brand-black);
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        transform: translate(-50%, -50%);
      }

      .seat:hover {
        transform: translate(-50%, -50%) scale(1.2);
        z-index: 10;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      }

      .seat.member {
        background: var(--success);
        color: var(--brand-cream);
      }

      .seat.guest {
        background: var(--brand-orange);
        color: var(--brand-cream);
      }

      .seat.empty {
        background: var(--gray-200);
        color: var(--gray-600);
        border-style: dashed;
        opacity: 0.6;
      }

      .seat-name {
        font-size: 0.75rem;
        font-weight: 700;
      }

      .seat-indicator {
        font-size: 1rem;
        margin-top: 0.125rem;
      }

      .seat-number {
        font-size: 1.25rem;
        font-weight: 700;
      }

      /* ROOM TABS */
      .room-tabs {
        display: flex;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: var(--gray-700);
        border-top: 2px solid var(--brand-orange);
        overflow-x: auto;
      }

      .room-tab-label {
        font-size: 0.625rem;
        font-weight: 700;
        color: var(--gray-400);
        letter-spacing: 0.05em;
        margin-right: 1rem;
        align-self: center;
      }

      .room-tab {
        padding: 0.75rem 1rem;
        background: var(--gray-600);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 150ms;
        min-width: 120px;
      }

      .room-tab:hover {
        background: var(--gray-500);
      }

      .room-tab.active {
        background: var(--brand-orange);
      }

      .room-tab-title {
        font-weight: 700;
        color: var(--brand-cream);
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
      }

      .room-tab-info {
        font-size: 0.75rem;
        color: var(--gray-200);
      }

      /* RIGHT: DETAIL PANEL */
      .detail-panel {
        background: var(--gray-50);
        border-left: 3px solid var(--brand-orange);
        overflow-y: auto;
        padding: 2rem;
      }

      .detail-empty {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-500);
        font-size: 0.875rem;
      }

      .detail-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-300);
      }

      .detail-header h3 {
        font-size: 1.25rem;
      }

      .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
      }

      .status-confirmed {
        background: var(--success);
        color: white;
      }

      .status-pending {
        background: var(--brand-orange);
        color: white;
      }

      .detail-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .detail-section h4 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }

      .detail-section p {
        font-size: 0.875rem;
        color: var(--gray-600);
        line-height: 1.5;
      }

      .attendee-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .attendee-item {
        padding: 1rem;
        background: white;
        border-radius: 0.5rem;
        border-left: 3px solid var(--success);
      }

      .attendee-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .attendee-type {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .attendee-type.member {
        background: var(--success);
        color: white;
      }

      .attendee-type.guest {
        background: var(--brand-orange);
        color: white;
      }

      .dietary-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .tag {
        padding: 0.25rem 0.5rem;
        background: var(--gray-200);
        color: var(--gray-700);
        border-radius: 0.25rem;
        font-size: 0.6875rem;
        font-weight: 600;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        font-size: 1.25rem;
        color: var(--gray-500);
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- TOP BAR -->
      <div class="top-bar">
        <div></div>
        <div class="header-center">
          <h1>Sterling Catering</h1>
          <p>Reservation & Seating Management</p>
        </div>
        <div class="top-right">
          <div id="loginSection" class="login-section">
            <input
              type="email"
              id="emailInput"
              placeholder="Email"
              value="josh@josh.com"
            />
            <input
              type="password"
              id="passwordInput"
              placeholder="Password"
              value="1111"
            />
            <button onclick="login()">Login</button>
          </div>
          <div class="badge time-badge" id="currentTime"></div>
        </div>
      </div>

      <!-- MAIN LAYOUT -->
      <div class="main-layout">
        <!-- LEFT: TABLES GRID -->
        <div class="tables-grid-container">
          <div class="room-header">
            <h2 id="roomName">Loading...</h2>
            <p id="roomInfo"></p>
          </div>
          <div class="tables-grid" id="tablesGrid">
            <div class="loading">Login to view tables</div>
          </div>

          <!-- ROOM TABS -->
          <div class="room-tabs" id="roomTabs"></div>
        </div>

        <!-- RIGHT: DETAIL PANEL -->
        <div class="detail-panel">
          <div class="detail-empty" id="detailPanel">
            Select a table to view details
          </div>
        </div>
      </div>
    </div>

    <script>
      const API = "http://127.0.0.1:8080";
      let token = null;
      let rooms = [];
      let tables = [];
      let reservations = [];
      let activeRoomId = null;

      // Update time
      function updateTime() {
        const now = new Date();
        document.getElementById("currentTime").textContent =
          now.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
          });
      }
      setInterval(updateTime, 1000);
      updateTime();

      // API call helper
      async function api(endpoint, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          ...(token && { Authorization: `Bearer ${token}` }),
        };
        const res = await fetch(`${API}${endpoint}`, { ...options, headers });
        return {
          ok: res.ok,
          status: res.status,
          data: await res.json().catch(() => ({})),
        };
      }

      // Login
      async function login() {
        const email = document.getElementById("emailInput").value;
        const password = document.getElementById("passwordInput").value;

        const res = await api("/api/users/login/", {
          method: "POST",
          body: JSON.stringify({ email, password }),
        });

        if (res.ok) {
          token = res.data.access_token;
          document.getElementById("loginSection").innerHTML = `
          <div class="badge">Logged in as ${res.data.user.name}</div>
        `;
          await loadAllData();
        } else {
          alert("Login failed");
        }
      }

      // Load all data
      async function loadAllData() {
        document.getElementById("tablesGrid").innerHTML =
          '<div class="loading">Loading...</div>';

        // Fetch rooms first
        const roomsRes = await api("/api/dining-rooms");
        rooms = roomsRes.data || [];

        // Then fetch tables for each room
        tables = [];
        for (const room of rooms) {
          const tablesRes = await api(`/api/dining-rooms/${room.id}/tables`);
          if (tablesRes.ok && tablesRes.data) {
            tables = tables.concat(tablesRes.data);
          }
        }

        // Fetch reservations
        const reservationsRes = await api("/api/reservations");
        reservations = reservationsRes.data || [];

        // Fetch attendees for each reservation
        for (const reservation of reservations) {
          const attendeesRes = await api(
            `/api/reservation-attendees/reservation/${reservation.id}`,
          );
          reservation.attendees = attendeesRes.ok ? attendeesRes.data : [];
        }

        activeRoomId = rooms[0]?.id;
        renderRoomTabs();
        renderTables();
      }

      // Render room tabs
      function renderRoomTabs() {
        const html = `
        <span class="room-tab-label">DINING ROOMS</span>
        ${rooms
          .map((room) => {
            const roomTables = tables.filter(
              (t) => t.dining_room_id === room.id,
            );
            const occupiedCount = reservations.filter(
              (r) => r.dining_room_id === room.id,
            ).length;
            return `
            <div class="room-tab ${room.id === activeRoomId ? "active" : ""}" 
                 onclick="switchRoom(${room.id})">
              <div class="room-tab-title">${room.name}</div>
              <div class="room-tab-info">${roomTables.length} Tables • ${occupiedCount} Occ</div>
            </div>
          `;
          })
          .join("")}
      `;
        document.getElementById("roomTabs").innerHTML = html;
      }

      // Switch room
      function switchRoom(roomId) {
        activeRoomId = roomId;
        renderRoomTabs();
        renderTables();
      }

      // Calculate seat positions around table
      function calculateSeatPositions(seatCount) {
        const tableRadius = 90;
        const seatRadius = 37.5;
        const distance = tableRadius + seatRadius + 10;
        const positions = [];

        for (let i = 0; i < seatCount; i++) {
          const angle = (i * 360) / seatCount - 90;
          const radian = (angle * Math.PI) / 180;
          positions.push({
            top: tableRadius + Math.sin(radian) * distance,
            left: tableRadius + Math.cos(radian) * distance,
          });
        }

        return positions;
      }

      // Render tables
      function renderTables() {
        const room = rooms.find((r) => r.id === activeRoomId);
        const roomTables = tables.filter(
          (t) => t.dining_room_id === activeRoomId,
        );
        const roomReservations = reservations.filter(
          (r) => r.dining_room_id === activeRoomId,
        );

        document.getElementById("roomName").textContent = room.name;
        document.getElementById("roomInfo").textContent =
          `Capacity: ${room.capacity} | Tables: ${roomTables.length}`;

        const html = roomTables
          .map((table) => {
            const reservation = roomReservations.find(
              (r) => r.table_id === table.id,
            );
            const attendees = reservation?.attendees || [];
            const seatPositions = calculateSeatPositions(table.seat_count);

            return `
          <div class="table-view">
            <div class="table-container" onclick="showTableDetail(${table.id})">
              <div class="table-center">
                ${reservation ? `<span class="res-badge">#${reservation.id}</span>` : ""}
                <strong>TABLE ${table.table_number}</strong>
                <span>${attendees.length} / ${table.seat_count}</span>
              </div>
              
              ${seatPositions
                .map((pos, idx) => {
                  const attendee = attendees[idx];
                  const seatClass = attendee ? attendee.attendee_type : "empty";
                  return `
                  <div class="seat ${seatClass}" 
                       style="top: ${pos.top}px; left: ${pos.left}px;"
                       onclick="event.stopPropagation();">
                    ${
                      attendee
                        ? `
                      <span class="seat-name">${attendee.name}</span>
                      <span class="seat-indicator">✓</span>
                    `
                        : `
                      <span class="seat-number">${idx + 1}</span>
                    `
                    }
                  </div>
                `;
                })
                .join("")}
            </div>
          </div>
        `;
          })
          .join("");

        document.getElementById("tablesGrid").innerHTML =
          html || '<div class="loading">No tables in this room</div>';
      }

      // Show table detail
      function showTableDetail(tableId) {
        const table = tables.find((t) => t.id === tableId);
        const reservation = reservations.find((r) => r.table_id === tableId);

        if (!reservation) {
          document.getElementById("detailPanel").innerHTML = `
          <div class="detail-content">
            <h3>Table ${table.table_number}</h3>
            <p>No active reservation</p>
          </div>
        `;
          return;
        }

        const attendees = reservation.attendees || [];

        const html = `
        <div class="detail-content">
          <div class="detail-header">
            <h3>Reservation #${reservation.id}</h3>
            <span class="status-badge status-${reservation.status}">${reservation.status}</span>
          </div>
          
          <div class="detail-section">
            <h4>Reservation Details</h4>
            <p><strong>Table:</strong> ${table.table_number}</p>
            <p><strong>Party Size:</strong> ${reservation.party_size || attendees.length}</p>
            <p><strong>Date:</strong> ${reservation.date}</p>
            <p><strong>Time:</strong> ${reservation.start_time} - ${reservation.end_time}</p>
            <p><strong>Meal Type:</strong> ${reservation.meal_type}</p>
          </div>
          
          ${
            attendees.length > 0
              ? `
            <div class="detail-section">
              <h4>Attendees (${attendees.length})</h4>
              <div class="attendee-list">
                ${attendees
                  .map((attendee, idx) => {
                    const dietary = attendee.dietary_restrictions || {};
                    const tags = Object.entries(dietary)
                      .filter(([_, v]) => v)
                      .map(([k]) => k);
                    return `
                    <div class="attendee-item">
                      <div class="attendee-info">
                        <strong>Seat ${idx + 1}: ${attendee.name}</strong>
                        <span class="attendee-type ${attendee.attendee_type}">${attendee.attendee_type}</span>
                      </div>
                      ${
                        tags.length > 0
                          ? `
                        <div class="dietary-tags">
                          ${tags.map((tag) => `<span class="tag">${tag}</span>`).join("")}
                        </div>
                      `
                          : ""
                      }
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            </div>
          `
              : ""
          }
        </div>
      `;

        document.getElementById("detailPanel").innerHTML = html;
      }
    </script>
  </body>
</html>
